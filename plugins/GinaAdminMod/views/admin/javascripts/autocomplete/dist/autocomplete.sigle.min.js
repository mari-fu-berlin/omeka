/*
 *  Item-Sigle-Autocomplete - v1.0.0
 *  Autocomplete for Omeka items' sigle elements
 *
 *  Made by Viktor Grandgeorg
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.init()}var f="autocompleteSigle",g={adminBaseUrl:"/omeka/admin",warnNoItemFound:"Kein passendes Objekt gefunden!",itemType:27};a.extend(e.prototype,{init:function(){this.formatAutocompletefield(this.element),this.formatAutofield(this.settings.autofield),this.setAutocomplete()},formatAutofield:function(b){var c=a(b),d=a("textarea",c),e=d.attr("name"),f=d.attr("id");this.settings.autoFieldCurrentId=f;var g=d.val();c.addClass("gina-element-auto-field"),d.remove();var h=a(".input",c).append('<input type="hidden" name="'+e+'" id="'+f+'" class="readonly" readonly>');a("#"+f,h).val(g);var i="/",j="";g>0&&(i=this.settings.adminBaseUrl+"/items/show/"+g,j="ID: "+g),a(".input",c).append('<a href="'+i+'" id="link-'+f+'" target="_blank">'+j+"</a>")},formatAutocompletefield:function(b){var c=a(b),d=a("textarea",c),e=d.attr("name"),f=d.attr("id");this.settings.autocompleteFieldCurrentId=f;var g=d.val();g!==this.settings.currentAutocompleteFieldValue&&(g=this.settings.currentAutocompleteFieldValue),c.addClass("gina-element-auto-field"),d.remove();var h=a(".input",c).append('<input type="text" name="'+e+'" id="'+f+'">');a("#"+f,h).val(g)},setAutocomplete:function(){var b=this.settings,c=a("#"+this.settings.autocompleteFieldCurrentId,this.element),d=this;a.widget("custom.catcomplete",a.ui.autocomplete,{_create:function(){this._super(),this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(b,c){var d=this,e="";a.each(c,function(a,c){var f;c.category!==e&&(b.append('<li class="ui-autocomplete-category">'+c.category+"</li>"),e=c.category),f=d._renderItemData(b,c),c.category&&f.attr("aria-label",c.category+" : "+c.label)})}}),c.catcomplete({source:b.adminBaseUrl+"/gina-admin-mod/item-autocomplete-complex?type="+b.itemType,minLength:1,select:function(c,d){b.selectedAutocompleteFieldValue=d.item.value,b.selectedAutoFieldValue=d.item.item_id,a("#"+b.autoFieldCurrentId).val(d.item.item_id),a("#link-"+b.autoFieldCurrentId).attr("href",b.adminBaseUrl+"/items/show/"+d.item.item_id).html("ID: "+d.item.item_id)},response:function(a,c){b.uiDataCache=c.content},change:function(e,f){if(!f.item)if(void 0!==b.uiDataCache&&1===b.uiDataCache.length&&a(e.target).val().length>0&&a(e.target).val()===b.uiDataCache[0].value)b.selectedAutocompleteFieldValue=b.uiDataCache[0].value,b.selectedAutoFieldValue=b.uiDataCache[0].item_id,a(e.target).val(b.uiDataCache[0].value),a("#"+b.autoFieldCurrentId).val(b.uiDataCache[0].item_id),a("#link-"+b.autoFieldCurrentId).attr("href",b.adminBaseUrl+"/items/show/"+b.uiDataCache[0].item_id).html("ID: "+b.uiDataCache[0].item_id);else if(0===a(e.target).val().length){a("#"+b.autoFieldCurrentId).val("");var g=a('<div style="display:none; color:#f30;" id="autocomp-del-msg">gelöscht</div>');a("#link-"+b.autoFieldCurrentId).attr("href",b.adminBaseUrl+"/").html("").append(g),a("#autocomp-del-msg").fadeIn(600,function(){a(this).fadeOut(600,function(){a(this).remove()})}),b.selectedAutocompleteFieldValue="",b.selectedAutoFieldValue=""}else void 0!==b.selectedAutocompleteFieldValue&&b.selectedAutocompleteFieldValue.length>0&&c.val()!==b.selectedAutocompleteFieldValue?(d.displayErrorDialog(c,"Ihre vorherige Auswahl"),a(e.target).val(b.selectedAutocompleteFieldValue),a("#"+b.autoFieldCurrentId).val(b.selectedAutoFieldValue),a("#link-"+b.autoFieldCurrentId).attr("href",b.adminBaseUrl+"/items/show/"+b.selectedAutoFieldValue).html("ID: "+b.selectedAutoFieldValue)):b.currentAutocompleteFieldValue.length>0&&b.currentAutoFieldValue>0?(d.displayErrorDialog(c,"den gespeicherten Wert"),a(e.target).val(b.currentAutocompleteFieldValue),a("#"+b.autoFieldCurrentId).val(b.currentAutoFieldValue),a("#link-"+b.autoFieldCurrentId).attr("href",b.adminBaseUrl+"/items/show/"+b.currentAutoFieldValue).html("ID: "+b.currentAutoFieldValue)):(d.displayErrorDialog(c,"leere Werte"),a(e.target).val(""),a("#"+b.autoFieldCurrentId).val(""),a("#link-"+b.autoFieldCurrentId).attr("href",b.adminBaseUrl+"/").html(""))},focus:function(){return!1}}),c.closest("form").submit(function(d){0===c.val().length&&a("#"+b.autoFieldCurrentId).val(""),(c.val().length>0&&0===a("#"+b.autoFieldCurrentId).val().length||a("#"+b.autoFieldCurrentId).val()===b.currentAutoFieldValue&&c.val().length>0&&c.val()!==b.currentAutocompleteFieldValue||void 0!==b.selectedAutocompleteFieldValue&&b.selectedAutocompleteFieldValue.length>0&&c.val()!==b.selectedAutocompleteFieldValue)&&(d.preventDefault(),c.trigger("blur"))})},displayErrorDialog:function(b,c){for(var d=this.settings.itemType.split(","),e="<ul>",f=0;f<d.length;f++)e=e+'<li><a href="'+this.settings.adminBaseUrl+"/items/add?type="+d[f]+'" target="_blank">'+this.settings.itemTypes[d[f]]+"</a></li>";e+="</ul>";var g=a("<div>").text(b.val()).html();a("<div />").html("<p>Sie haben einen Wert in der Sigle-Quelle angeggeben. Sie haben diesen aber nicht durch die Auswahl aus der Liste bestätigt. Bitte korrigieren Sie das. Sollte die Quelle in der Liste nicht exisitieren, legen Sie die Quelle vorher an.<p><p>Ihre Eingabe lautete: <strong>"+g+"</strong></p><p>Sie wurde zurückgesetzt auf "+c+". <p>Folgende Quelltypen werden bei diesem Objekt berücksichtigt:</p>"+e).dialog({modal:!0,buttons:[{text:"OK",click:function(){a(this).dialog("close")}}],open:function(){a("button",a(this).siblings(".ui-dialog-buttonpane")).focus()}})}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document);