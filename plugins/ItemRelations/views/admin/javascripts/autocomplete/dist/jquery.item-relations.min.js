/*
 *  Item-Relations-Autocomplete - v1.0.0
 *  Autocomplete for Omeka ItemRelations Plugin
 *
 *  Made by Viktor Grandgeorg
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.searchCache={},this.checkCache={},this.init()}var f="itemrelationsAutocomplete",g={adminBaseUrl:"/admin",warnNoItemFound:"Kein passendes Objekt gefunden!",itemType:27};a.extend(e.prototype,{init:function(){this.addgparentJQueryFunction(),this.bindItemRelations(),this.setAddRow()},addgparentJQueryFunction:function(){a.fn.gparent=function(b){return b>1?a(this).parent().gparent(b-1):a(this).parent()}},bindItemRelations:function(){var b=this;a(".item-relations-entry",this.element).each(function(){var c=a(".ui-widget input",a(this).last()),d=a(".search",a(this).last());b.setAutocomplete(c),b.setSearch(d,c)})},setSearch:function(b,c){var d=a(".search-input",b);d.length&&d.remove();var e=a('<input type="text">');e.addClass("search-input");var f=this.settings,g=this.searchCache;a.widget("custom.catcomplete",a.ui.autocomplete,{_create:function(){this._super(),this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(b,c){var d=this,e="";a.each(c,function(a,c){var f;c.category!==e&&(b.append('<li class="ui-autocomplete-category">'+c.category+"</li>"),e=c.category),f=d._renderItemData(b,c),c.category&&f.attr("aria-label",c.category+" : "+c.label)})}}),e.catcomplete({source:function(b,c){var d=b.term;if(d in g)return void c(g[d]);a.getJSON("/admin/gina-admin-mod/item-autocomplete-complex?type="+f.itemType,b,function(a){g[d]=a,c(a)})},minLength:1,select:function(a,b){c.val(b.item.item_id).trigger("input")},focus:function(){return!1}}),b.append(e)},syncSearch:function(b,c){var d=a(".search-input",b.gparent(2));d.length&&d.val()!==c.sigle&&d.val(c.sigle)},showAutocompleteResult:function(b,c){var d=this.settings,e=a(".selected-autocomplete",b.gparent(2));c.hasOwnProperty("status")?200===c.status?e.html('<a href="'+d.adminBaseUrl+"/items/show/"+c.id+'" target="_blank">'+c.sigle+"</a>").show("fade",{},500):e.html('<div class="warn">'+d.warnNoItemFound+"</div>").show("fade",{},500):e.html("").hide("fade",{},500)},setAutocomplete:function(b){var c=this.settings,d=this.checkCache,e=this;b.bind("input",function(){var f=a(this).val();f.length>0&&(f in d?(e.showAutocompleteResult(b,d[f]),e.syncSearch(b,d[f])):a.getJSON(c.adminBaseUrl+"/gina-admin-mod/item-autocomplete-id/"+f,function(a){d[f]=a,e.showAutocompleteResult(b,a),e.syncSearch(b,a)}))})},setAddRow:function(){var b=this;a("#item-relations-add-relation").click(function(){var c=a(".item-relations-new-entry").last(),d=a(".item-relations-entry-annotation").last(),e=c.clone(),f=a(".search",e),g=a("textarea",d).attr("name").match(/\[(\d+)\]/),h="item_relations_new_annotation["+(parseInt(g[1])+1)+"]",i=a('<tr class="item-relations-entry-annotation"><td colspan="4"><label for="'+h+'" style="margin-bottom: 8px; display: block;">Annotationen</label><textarea name="'+h+'" id="'+h+'" style="width:100%;"></textarea></td></tr>');e.insertAfter(d),i.insertAfter(e);var j=a(".ui-widget input",e),k=e.find("select");j.val(""),k.val(""),a(".selected-autocomplete",e).html("").hide(),j.unbind("input"),b.setAutocomplete(j),b.setSearch(f,a(".ui-widget input",e)),tinyMCE.execCommand("mceAddControl",!0,h)})}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document);